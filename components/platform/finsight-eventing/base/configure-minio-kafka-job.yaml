apiVersion: batch/v1
kind: Job
metadata:
  name: configure-minio-kafka
  namespace: minio
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "50"
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: configure-minio-kafka
    spec:
      restartPolicy: OnFailure
      containers:
        - name: mc
          image: quay.io/minio/mc:RELEASE.2024-10-13T16-33-53Z
          imagePullPolicy: IfNotPresent
          env:
            - name: MINIO_ENDPOINT
              value: http://minio.minio.svc.cluster.local:9000
            - name: KAFKA_BOOTSTRAP
              value: finsight-kafka-kafka-bootstrap.kafka.svc.cluster.local:9092
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: accesskey
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: secretkey
          command:
            - /bin/sh
            - -c
            - |-
              set -euo pipefail

              mc alias set finsight "${MINIO_ENDPOINT}" "${MINIO_ACCESS_KEY}" "${MINIO_SECRET_KEY}"

              mc admin config set finsight notify_kafka:FINSIGHT \
                "enable=on" \
                "brokers=${KAFKA_BOOTSTRAP}" \
                "topic=minio-bucket-notifications" \
                "comment=Audio file upload notifications for FinSight"

              mc admin config set finsight notify_kafka:EVENTS \
                "enable=on" \
                "brokers=${KAFKA_BOOTSTRAP}" \
                "topic=minio-bucket-notifications"

              mc event remove finsight/audio-inbox --force >/dev/null 2>&1 || true
              mc event add finsight/audio-inbox arn:minio:sqs::EVENTS:kafka --event put

              mc admin service restart finsight --json
